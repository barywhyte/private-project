permissions:
  contents: write

name: CI Pipeline

on:
  push:
    branches:
      - main
      - operations
  pull_request:

env:
  IMAGE_NAME: docker.io/barywhyte/api

jobs:
  run_test:
    name: Run Tests
    runs-on: ubuntu-latest

    container:
      image: python:3.11-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests with pytest
        run: pytest

  build_and_scan_image:
    name: Build & Scan Docker Image
    runs-on: ubuntu-latest
    needs: run_test

    services:
      docker:
        image: docker:28.2.2-dind
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set environment variables
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Download latest Trivy
        run: |
          TRIVY_VERSION=$(wget -qO - "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          wget --no-verbose https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz -O - | tar -zxvf -
          chmod +x trivy

      - name: Build Docker Image
        run: docker buildx build --platform linux/arm64 --load -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Trivy Scan (Vulnerabilities)
        run: |
          ./trivy image --download-db-only
          ./trivy image --scanners vuln --vuln-type library --severity HIGH,CRITICAL --format template --template "@contrib/gitlab.tpl" -o gl-container-scanning-report.json $IMAGE_NAME:$IMAGE_TAG

      - name: Trivy SBOM (CycloneDX)
        run: ./trivy image --format cyclonedx --output sbom.json $IMAGE_NAME:$IMAGE_TAG

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: |
            gl-container-scanning-report.json
            sbom.json
          retention-days: 7

  push_image:
    name: Push Docker Image
    runs-on: ubuntu-latest
    needs: build_and_scan_image

    services:
      docker:
        image: docker:28.2.2-dind
        options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set environment variables
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Login to DockerHub
        run: echo "${{ secrets.REGISTRY_PASS }}" | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker buildx build --platform linux/arm64 \
            --push \
            -t $IMAGE_NAME:$IMAGE_TAG \
            -t $IMAGE_NAME:latest .


  update_helm_values:
    name: Update Helm Values Image tag
    runs-on: ubuntu-latest
    needs: push_image

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Switch to operations branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout operations

      - name: Update image tag in values.yaml
        run: |
          yq -i ".image.tag = \"${IMAGE_TAG}\"" operations/api/values.yaml

      - name: Commit and push changes
        run: |
          git add operations/api/values.yaml
          git commit -m "Update image tag to $IMAGE_TAG"
          git push origin operations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

